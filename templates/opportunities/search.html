{% extends "base.html" %}
{% block content %}

<meta name="user-type" content="{{ user_type }}">
{% if user_type == "employer" %}
    {% include "employers/navbar.html" %}
{% elif user_type == "admin" %}
    {% include "user/navbar.html" %}
{% endif %}
<div class="container">
    <div class="card-wrapper card-dynamic-width">
        <div class="card search-card pb-5" style="border:none; border-bottom:1px solid silver;">
            <h1 class="center">Search Opportunities</h1>
            <form id="searchForm">
                <div class="form-group">
                    <div class="justify-content-start">
                        <label for="title">Title</label><br>
                        <input type="search" id="title" name="title" value="" class="tt-input"
                               autocomplete="on" spellcheck="false" dir="auto"
                               style="position: relative; vertical-align: top;" />
                    </div>
                    {% if user_type == "admin" %}
                    <div>
                        <label for="company">Company</label><br>
                        <input type="search" id="company" name="company" value="" class="tt-input"
                               autocomplete="on" spellcheck="false" dir="auto"
                               style="position: relative; vertical-align: top;" />
                    </div>
                    {% endif %}
                </div>
                <div class="form-group">
                    <p class="error error--hidden"></p>
                    <input type="submit" value="Search" class="btn btn-primary" />
                </div>
            </form>
        </div>

        <!-- Second Card: Table -->
        <div class="card card-dynamic-width" style="border:none;">
            <h1 class="center">Opportunities</h1>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Company Name</th>
                            <th>URL</th>
                            <th>Location</th>
                            <th>Modules Required</th>
                            <th>Courses Required</th>
                            <th>Spots Available</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="opportunity-table">
                        {% for opportunity in opportunities %}
                        <tr>
                            <td>{{ opportunity.title }}</td>
                            <td>{{ opportunity.description }}</td>
                            <td>{{ opportunity.company_name }}</td>
                            <td>
                                <a href="{{ opportunity.url }}" target="_blank">{{ opportunity.url }}</a>
                            </td>
                            <td>{{ opportunity.location }}</td>
                            <td>
                                {% if opportunity.modules_required %}
                                    {% if opportunity.modules_required|length > 3 %}
                                        <div class="module-list" id="module-list-{{ loop.index }}">
                                            <span class="short-list">
                                                {{ opportunity.modules_required[:3]|join(", ") }}... 
                                                <a href="javascript:void(0)" 
                                                   onclick="toggleList('module-list-{{ loop.index }}')"
                                                   style="color: #007bff; text-decoration: none;">
                                                    show more
                                                </a>
                                            </span>
                                            <span class="full-list" style="display: none;">
                                                {{ opportunity.modules_required|join(", ") }}
                                                <a href="javascript:void(0)" 
                                                   onclick="toggleList('module-list-{{ loop.index }}')"
                                                   style="color: #007bff; text-decoration: none;">
                                                    show less
                                                </a>
                                            </span>
                                        </div>
                                    {% else %}
                                        {{ opportunity.modules_required|join(", ") }}
                                    {% endif %}
                                {% else %}
                                    Not required
                                {% endif %}
                            </td>
                            <td>
                                {% if opportunity.courses_required %}
                                    {% if opportunity.courses_required|length > 3 %}
                                        <div class="course-list" id="course-list-{{ loop.index }}">
                                            <span class="short-list">
                                                {{ opportunity.courses_required[:3]|join(", ") }}... 
                                                <a href="javascript:void(0)" 
                                                   onclick="toggleList('course-list-{{ loop.index }}')"
                                                   style="color: #007bff; text-decoration: none;">
                                                    show more
                                                </a>
                                            </span>
                                            <span class="full-list" style="display: none;">
                                                {{ opportunity.courses_required|join(", ") }}
                                                <a href="javascript:void(0)" 
                                                   onclick="toggleList('course-list-{{ loop.index }}')"
                                                   style="color: #007bff; text-decoration: none;">
                                                    show less
                                                </a>
                                            </span>
                                        </div>
                                    {% else %}
                                        {{ opportunity.courses_required|join(", ") }}
                                    {% endif %}
                                {% else %}
                                    Not required
                                {% endif %}
                            </td>
                            <td>{{ opportunity.spots_available }}</td>
                            <td>{{ opportunity.duration|replace('_', ' ') }}</td>
                            <td>
                                {% if user_type != "admin" %}
                                    {% if student_deadline and student_deadline > current_time %}
                                        <button class="btn btn-sm btn-secondary" 
                                                title="Student deadline not reached" 
                                                disabled>
                                            <i class="fas fa-sort-amount-up"></i> Rank
                                        </button>
                                    {% elif employer_deadline and current_time > employer_deadline %}
                                        <button class="btn btn-sm btn-secondary" 
                                                title="Employer ranking deadline has passed" 
                                                disabled>
                                            <i class="fas fa-sort-amount-up"></i> Rank
                                        </button>
                                    {% else %}
                                        <a href="{{ url_for('employers_rank_students', opportunity_id=opportunity._id) }}"
                                           class="btn btn-sm btn-info">
                                           <i class="fas fa-sort-amount-up"></i> Rank
                                        </a>
                                    {% endif %}
                                {% endif %}
                                <a href="{{ url_for('employer_add_update_opportunity', opportunity_id=opportunity._id) }}"
                                   class="btn btn-sm btn-primary" style="margin-bottom: 10px;">
                                   <i class="fas fa-edit"></i> Update
                                </a>
                                <a href="javascript:void(0);" onclick="confirmDelete('{{ opportunity._id }}')"
                                   class="btn btn-sm btn-danger">
                                   <i class="fas fa-trash"></i> Delete
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-3 mb-4">
                <button id="downloadExcelBtn" class="btn btn-small">
                    <i class="fas fa-download"></i> Download as Excel
                </button>
                <button id="deleteAllEmployersBtn" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete All Opportunities
                </button>
            </div>
        </div>
    </div>
</div>



    <script>
        function toggleList(elementId) {
            const container = document.getElementById(elementId);
            const shortList = container.querySelector('.short-list');
            const fullList = container.querySelector('.full-list');

            if (fullList.style.display === 'none') {
                shortList.style.display = 'none';
                fullList.style.display = 'inline';
            } else {
                shortList.style.display = 'inline';
                fullList.style.display = 'none';
            }
        }

        function confirmDelete(opportunityId) {
            if (confirm("Are you sure you want to delete this opportunity?")) {
                window.location.href = `/opportunities/employer_delete_opportunity?opportunity_id=${opportunityId}`;
            }
        }

        
    </script>
    <script>
        document.getElementById('deleteAllEmployersBtn').addEventListener('click', function () {
            Swal.fire({
                title: 'Are you sure?',
                text: "All opportunities will be permanently deleted!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete all!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "/opportunities/delete_all";
                }
            });
        });
    </script>
    <script>
        function toggleList(elementId) {
            const container = document.getElementById(elementId);
            const shortList = container.querySelector('.short-list');
            const fullList = container.querySelector('.full-list');
    
            if (fullList.style.display === 'none') {
                shortList.style.display = 'none';
                fullList.style.display = 'inline';
            } else {
                shortList.style.display = 'inline';
                fullList.style.display = 'none';
            }
        }
    
        function confirmDelete(opportunityId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This opportunity will be permanently deleted.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/opportunities/employer_delete_opportunity?opportunity_id=${opportunityId}`;
                }
            });
        }
    
        document.addEventListener("DOMContentLoaded", function() {
            const flashMessage = "{{ get_flashed_messages()|join(' ') }}";
            if (flashMessage) {
                Swal.fire({
                    title: 'Notice',
                    text: flashMessage,
                    icon: 'info',
                    confirmButtonText: 'OK'
                });
            }
        });
    </script>
    <script src="/static/search_opportunities/script.js"></script>
{% endblock content %}
